{% extends "base.html" %}
{% load humanize %}
{% block content %}
<div class="container mt-4">
    <h2>Thanh toán học phí online</h2>
    <form method="post" id="payment-form">
        {% csrf_token %}
        <h4 class="mt-4">Các khoản học phí chưa thanh toán</h4>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th></th>
                    <th>Học kỳ</th>
                    <th>TC Lý thuyết</th>
                    <th>TC Thực hành</th>
                    <th>Tổng tiền</th>
                </tr>
            </thead>
            <tbody>
                {% for debt in unpaid_tuition %}
                <tr>
                    <td>
                        <input type="checkbox" class="fee-checkbox" name="tuition_ids" value="{{ debt.id }}" data-amount="{{ debt.total_amount }}">
                    </td>
                    <td>{{ debt.semester }}</td>
                    <td>{{ debt.theory_credits }}</td>
                    <td>{{ debt.practice_credits }}</td>
                    <td>{{ debt.total_amount|intcomma }} VNĐ</td>
                </tr>
                {% empty %}
                <tr><td colspan="5" class="text-center">Không có công nợ học phí chưa thanh toán.</td></tr>
                {% endfor %}
            </tbody>
        </table>
        <h4 class="mt-4">Các khoản thu khác chưa thanh toán</h4>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th></th>
                    <th>Học kỳ</th>
                    <th>Tên khoản thu</th>
                    <th>Số tiền</th>
                </tr>
            </thead>
            <tbody>
                {% for fee in unpaid_other %}
                <tr>
                    <td>
                        <input type="checkbox" class="fee-checkbox" name="other_ids" value="{{ fee.id }}" data-amount="{{ fee.amount }}">
                    </td>
                    <td>{{ fee.semester }}</td>
                    <td>{{ fee.name }}</td>
                    <td>{{ fee.amount|intcomma }} VNĐ</td>
                </tr>
                {% empty %}
                <tr><td colspan="4" class="text-center">Không có khoản thu nào chưa thanh toán.</td></tr>
                {% endfor %}
            </tbody>
        </table>
        <div class="mt-3 mb-3">
            <b>Tổng số tiền cần thanh toán: <span id="total-amount">0</span> VNĐ</b>
        </div>
        <input type="hidden" name="total_amount" id="total-amount-input" value="0">
        <button type="submit" class="btn btn-primary">Thanh toán qua MoMo</button>
    </form>
</div>
<script>
    function updateTotal() {
        let total = 0;
        document.querySelectorAll('.fee-checkbox:checked').forEach(function(cb) {
            total += parseInt(cb.getAttribute('data-amount'));
        });
        document.getElementById('total-amount').innerText = total.toLocaleString();
        document.getElementById('total-amount-input').value = total;
    }
    document.querySelectorAll('.fee-checkbox').forEach(function(cb) {
        cb.addEventListener('change', updateTotal);
    });
</script>
{% endblock %}
